#	$Id$
#
# Makefile.in for top-level of pcc.
#

@SET_MAKE@

# Bootstrap configuration
BOOTSTRAP = @bootstrap@
BOOTSTRAP_STAGES = @bootstrap_stages@
BOOTSTRAP_COMPARE = @bootstrap_compare@

# C11/C23 portable libraries configuration
BUILD_LIBUNICODE=@BUILD_LIBUNICODE@
BUILD_LIBTHREAD=@BUILD_LIBTHREAD@

# Portable libraries are substituted by configure based on system needs
PORTABLE_LIBS=@PORTABLE_LIBS@

# Installation directories
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
libexecdir = @libexecdir@

C_SUBDIRS=	common/abi include
CC_SUBDIR=	cc
EXTRA_SUBDIRS=	pascal f77
ALL_SUBDIRS=	$(PORTABLE_LIBS) $(C_SUBDIRS) $(CC_SUBDIR)
DIST_SUBDIRS=	$(C_SUBDIRS) $(CC_SUBDIR) $(EXTRA_SUBDIRS) libunicode libthread libstdbit libckdint libdecimal libmetaware libblocks

# Default targets - conditional on bootstrap
all:
	@if [ "$(BOOTSTRAP)" = "yes" ]; then \
		$(MAKE) bootstrap-build; \
	else \
		$(MAKE) all-standard; \
	fi

install:
	@if [ "$(BOOTSTRAP)" = "yes" ]; then \
		$(MAKE) bootstrap-install; \
	else \
		$(MAKE) install-standard; \
	fi

# Minimal C-only build (stage 0 bootstrap)
all-c install-c clean-c:
	@target=`echo $@ | sed 's/-c//'`; \
	for subdir in $(C_SUBDIRS); do \
		_nextdir_=$${_thisdir_+$$_thisdir_/}$$subdir; \
		echo "===> $$_nextdir_"; \
		(_thisdir_=$$_nextdir_; export _thisdir_; cd $$subdir && \
		    exec $(MAKE) $(MFLAGS) $$target) || exit $$?; \
		echo "<=== $$_nextdir_"; \
	done
	@_nextdir_=cc; \
	echo "===> $$_nextdir_"; \
	(cd cc && exec $(MAKE) $(MFLAGS) `echo $@ | sed 's/-c//'`) || exit $$?; \
	echo "<=== $$_nextdir_"

# Standard build (C + C++)
all-standard install-standard clean:
	@for subdir in $(ALL_SUBDIRS); do \
		_nextdir_=$${_thisdir_+$$_thisdir_/}$$subdir; \
		echo "===> $$_nextdir_"; \
		(_thisdir_=$$_nextdir_; export _thisdir_; cd $$subdir && \
		    exec $(MAKE) $(MFLAGS) `echo $@ | sed 's/-standard//'`) || exit $$?; \
		echo "<=== $$_nextdir_"; \
	done

# Full build with all languages (C, C++, Pascal, F77)
all-full install-full clean-full:
	@target=`echo $@ | sed 's/-full//'`; \
	for subdir in $(C_SUBDIRS) $(CC_SUBDIR) $(EXTRA_SUBDIRS); do \
		_nextdir_=$${_thisdir_+$$_thisdir_/}$$subdir; \
		echo "===> $$_nextdir_"; \
		(_thisdir_=$$_nextdir_; export _thisdir_; cd $$subdir && \
		    exec $(MAKE) $(MFLAGS) $$target) || exit $$?; \
		echo "<=== $$_nextdir_"; \
	done

distclean:
	@for subdir in $(DIST_SUBDIRS); do \
		_nextdir_=$${_thisdir_+$$_thisdir_/}$$subdir; \
		echo "===> $$_nextdir_"; \
		(_thisdir_=$$_nextdir_; export _thisdir_; cd $$subdir && \
		    exec $(MAKE) $(MFLAGS) $@) || exit $$?; \
		echo "<=== $$_nextdir_"; \
	done
	rm -f config.log config.status include/config.h.in~ include/config.h

# Bootstrap build
bootstrap-build:
	@echo "Starting bootstrap build ($(BOOTSTRAP_STAGES) stages)"
	@$(MAKE) bootstrap-stage1
	@$(MAKE) bootstrap-stage2
	@if [ "$(BOOTSTRAP_STAGES)" = "3" ]; then \
		$(MAKE) bootstrap-stage3; \
		$(MAKE) bootstrap-compare; \
	fi

bootstrap-stage1:
	@echo "===> Bootstrap Stage 1: Building with system compiler"
	@$(MAKE) all-standard CC="$(CC)" CFLAGS="$(CFLAGS)"

bootstrap-stage2:
	@echo "===> Bootstrap Stage 2: Building with stage1 compiler"
	@$(MAKE) clean
	@$(MAKE) all-standard CC="./cc/ccom/ccom" CFLAGS="-O"

bootstrap-stage3:
	@echo "===> Bootstrap Stage 3: Building with stage2 compiler"
	@$(MAKE) clean
	@$(MAKE) all-standard CC="./cc/ccom/ccom" CFLAGS="-O"

bootstrap-compare:
	@echo "===> Comparing stage2 and stage3 compilers"
	@if $(BOOTSTRAP_COMPARE) cc/ccom/ccom.stage2 cc/ccom/ccom; then \
		echo "Bootstrap comparison successful"; \
	else \
		echo "Bootstrap comparison failed"; \
		exit 1; \
	fi

bootstrap-install:
	@echo "===> Installing bootstrapped compiler"
	@$(MAKE) install-standard

.PHONY: all install clean distclean all-c install-c clean-c \
	all-standard install-standard all-full install-full clean-full \
	bootstrap-build bootstrap-stage1 bootstrap-stage2 bootstrap-stage3 \
	bootstrap-compare bootstrap-install
